Tôi sẽ đọc tài liệu triển khai RabbitMQ để trả lời câu hỏi của bạn.## Trả lời câu hỏi của bạn

**Có, khi chạy localhost bạn CẦN chạy riêng worker!**

Theo kiến trúc RabbitMQ trong tài liệu, có  **2 process riêng biệt** :

| Process                 | Lệnh chạy                                                       | Vai trò                                                   |
| ----------------------- | ----------------------------------------------------------------- | ---------------------------------------------------------- |
| **API (FastAPI)** | `uvicorn app.main_app:app --reload --host 0.0.0.0 --port 30020` | Nhận request → Lưu DB → Publish to queue → Return 202 |
| **Worker**        | `python src/worker.py`                                          | Consume từ queue → Xử lý background → Update DB       |

### Cách chạy localhost:

**Terminal 1 - API:**

```bash
uvicorn app.main_app:app --reload --host 0.0.0.0 --port 30020
```

**Terminal 2 - Worker:**

```bash
python src/worker.py
```

**Terminal 3 - RabbitMQ (nếu chưa có):**

```bash
docker run -d --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:3-management
```

### Nếu dùng Docker Compose thì đơn giản hơn:

```bash
docker-compose up -d
```

Docker Compose sẽ tự động chạy cả 2 services (`app` + `worker`) như định nghĩa trong file `docker-compose.yml`.

### Lưu ý khi chạy localhost:

1. **RabbitMQ host** cần đổi từ `"rabbitmq"` (Docker service name) thành `"localhost"` trong config
2. **Database connection** cũng cần đổi tương tự
3. Worker cần chạy độc lập vì nó là **blocking consumer** - nó chờ message từ queue liên tục

Nếu không chạy worker, messages sẽ đọng trong queue và không được xử lý!self**.**db**.**query**(**ConversationEvent**)**.get**(**conversation_id**)**



```
┌─────────────────────────────────────────────────────────────────┐
│                        RabbitMQ Queue                           │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐               │
│  │Msg 1   │ │ Msg 2   │ │ Msg 3   │ │ Msg 4   │  ...          │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘               │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          │ Khi có message mới
                          ▼
              ┌───────────────────────┐
              │   Consumer (Worker)   │
              │                       │
              │  callback(message) ◄──┼── RabbitMQ tự động gọi
              │       │               │
              │       ▼               │
              │  Xử lý message        │
              │  - Parse JSON         │
              │  - Query DB           │
              │  - Tính score         │
              │  - Update DB          │
              └───────────────────────┘
```
